{% extends "base.html" %}
{% block title %}Summary & Analytics{% endblock %}

{% block content %}

<style>
.summary-container {
    max-width: 1100px;
    margin: 20px auto;
    padding: 10px;
}
.stat-row { display:flex; gap:20px; margin-bottom:20px; }
.stat-box {
    background: #fff;
    padding: 18px;
    border-radius: 12px;
    box-shadow: 0 4px 15px rgba(0,0,0,0.06);
    flex: 1;
    text-align: center;
}
.stat-title { color: #6b7280; font-weight:700; font-size:14px; }
.stat-value { color: #0b84ff; font-size:28px; font-weight:800; margin-top:6px; }

.card {
    background:#fff;
    border-radius:12px;
    padding:18px;
    box-shadow:0 4px 15px rgba(0,0,0,0.06);
    flex:1;
}

.charts-row { display:flex; gap:20px; margin-top:12px; }
.chart-container {
    height: 320px;       /* FIXED HEIGHT â€” prevents infinite expansion */
    width: 100%;
    position: relative;  /* required by Chart.js */
}
@media(max-width:900px){
  .stat-row { flex-direction: column; }
  .charts-row { flex-direction: column; }
}
</style>

<div class="summary-container">

  <h2 style="margin:0 0 6px">ðŸ“Š Summary & Analytics</h2>
  <p style="color:#6b7280; margin-bottom:18px">Insights from community-reported crime data.</p>

  <div class="stat-row">
    <div class="stat-box">
      <div class="stat-title">Total Reports</div>
      <div class="stat-value">{{ total }}</div>
    </div>
    <div class="stat-box">
      <div class="stat-title">Active (Reported)</div>
      <div class="stat-value">{{ active }}</div>
    </div>
    <div class="stat-box">
      <div class="stat-title">Closed</div>
      <div class="stat-value">{{ closed }}</div>
    </div>
  </div>

  <div class="charts-row">
    <div class="card">
      <h4 style="margin-top:0">Crimes by Type</h4>
      <div class="chart-container"><canvas id="typeChart"></canvas></div>
    </div>

    <div class="card">
      <h4 style="margin-top:0">Status Distribution</h4>
      <div class="chart-container"><canvas id="statusChart"></canvas></div>
    </div>
  </div>

</div>

{% endblock %}

{% block body_extra %}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<script>
/*
  SAFE JSON injection:
  - by_type is a Python dict (e.g. {"Theft":3,"Assault":1})
  - we stringify it on the server and parse here to avoid JS parse problems.
*/
const byType = JSON.parse(`{{ by_type | tojson | safe }}` || '{}');
const typeLabels = Object.keys(byType);
const typeValues = Object.values(byType);

// BAR CHART: Crimes by Type
const typeCtx = document.getElementById('typeChart').getContext('2d');
new Chart(typeCtx, {
  type: 'bar',
  data: {
    labels: typeLabels,
    datasets: [{
      label: 'Reports',
      data: typeValues,
      backgroundColor: typeLabels.map((_,i) => ['#0b84ff','#ff6b6b','#ffb86b','#9b59b6','#2ecc71','#ffa600'][i%6])
    }]
  },
  options: {
    responsive: true,
    maintainAspectRatio: false,   // crucial to stop expansion
    scales: { y: { beginAtZero: true, ticks: { precision:0 } } }
  }
});

// DONUT CHART: Status distribution (pulled from /reports/nearby)
fetch('/reports/nearby')
  .then(r => r.json())
  .then(data => {
    const statusCounts = { 'Reported':0, 'In Progress':0, 'Closed':0, 'Other':0 };
    data.forEach(it => {
      const s = it.status || 'Other';
      if (statusCounts[s] !== undefined) statusCounts[s] += 1;
      else statusCounts['Other'] += 1;
    });

    const statusCtx = document.getElementById('statusChart').getContext('2d');
    new Chart(statusCtx, {
      type: 'doughnut',
      data: {
        labels: Object.keys(statusCounts),
        datasets: [{
          data: Object.values(statusCounts),
          backgroundColor: ['#0b84ff', '#ffb86b', '#2ecc71', '#9aa0a6'],
          borderWidth: 0
        }]
      },
      options: {
        responsive: true,
        maintainAspectRatio: false, // crucial
        cutout: '60%'
      }
    });
  })
  .catch(err => {
    console.error('Failed to load nearby reports for summary:', err);
  });
</script>
{% endblock %}
